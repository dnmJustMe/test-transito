RewriteEngine On

# Configuración de seguridad
ServerTokens Prod
ServerSignature Off

# Headers de seguridad
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Ocultar información del servidor
Header unset Server
Header unset X-Powered-By

# Proteger archivos sensibles
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|bak)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Proteger directorios de configuración
RedirectMatch 404 /\..*$
RedirectMatch 404 /config/.*$
RedirectMatch 404 /logs/.*$

# Comprimir archivos para mejor rendimiento
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Cache para archivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# URLs amistosas para la aplicación

# Redirigir a HTTPS (descomentar en producción)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# API Routes
RewriteRule ^api/v1/auth/?(.*)$ api/v1/auth.php?action=$1 [QSA,L]
RewriteRule ^api/v1/questions/?(.*)$ api/v1/questions.php?action=$1 [QSA,L]
RewriteRule ^api/v1/tests/?(.*)$ api/v1/tests.php?action=$1 [QSA,L]
RewriteRule ^api/v1/users/?(.*)$ api/v1/users.php?action=$1 [QSA,L]

# Admin Routes
RewriteRule ^admin/?$ admin/index.php [L]
RewriteRule ^admin/login/?$ admin/login.php [L]
RewriteRule ^admin/dashboard/?$ admin/dashboard.php [L]
RewriteRule ^admin/questions/?$ admin/questions.php [L]
RewriteRule ^admin/questions/create/?$ admin/questions.php?action=create [L]
RewriteRule ^admin/questions/edit/([0-9]+)/?$ admin/questions.php?action=edit&id=$1 [L]
RewriteRule ^admin/users/?$ admin/users.php [L]
RewriteRule ^admin/users/edit/([0-9]+)/?$ admin/users.php?action=edit&id=$1 [L]
RewriteRule ^admin/tests/?$ admin/tests.php [L]
RewriteRule ^admin/tests/view/([0-9]+)/?$ admin/tests.php?action=view&id=$1 [L]
RewriteRule ^admin/settings/?$ admin/settings.php [L]

# Public Routes
RewriteRule ^login/?$ public/login.php [L]
RewriteRule ^register/?$ public/register.php [L]
RewriteRule ^dashboard/?$ public/dashboard.php [L]
RewriteRule ^profile/?$ public/profile.php [L]
RewriteRule ^test/?$ public/test.php [L]
RewriteRule ^test/start/?$ public/test.php?action=start [L]
RewriteRule ^test/([0-9]+)/?$ public/test.php?session_id=$1 [L]
RewriteRule ^history/?$ public/history.php [L]
RewriteRule ^results/([0-9]+)/?$ public/results.php?session_id=$1 [L]
RewriteRule ^logout/?$ public/logout.php [L]

# Ruta principal - redirigir a dashboard si está logueado, sino a login
RewriteRule ^$ public/index.php [L]

# Manejo de errores personalizados
ErrorDocument 400 /error.php?code=400
ErrorDocument 401 /error.php?code=401
ErrorDocument 403 /error.php?code=403
ErrorDocument 404 /error.php?code=404
ErrorDocument 500 /error.php?code=500

# Prevenir acceso directo a archivos PHP en ciertos directorios
RewriteRule ^(classes|models|config|middleware|utils)/ - [F,L]

# Bloquear bots maliciosos (opcional)
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC,OR]
RewriteCond %{THE_REQUEST} (\?|\*|%2a)+(%20+|\\s+|%20+\\s+|\\s+%20+|\\s+%20+\\s+)(http|https)(:/|/) [NC,OR]
RewriteCond %{THE_REQUEST} etc/passwd [NC,OR]
RewriteCond %{THE_REQUEST} cgi-bin [NC,OR]
RewriteCond %{THE_REQUEST} (%0A|%0D) [NC]
RewriteRule .* - [F,L]

# Limitar tamaño de subida
LimitRequestBody 10485760

# Configuración de tipos MIME
AddType application/json .json
AddType application/javascript .js
AddType text/css .css

# Configuración de charset por defecto
AddDefaultCharset UTF-8

# Índices de directorio deshabilitados
Options -Indexes

# Seguir enlaces simbólicos
Options +FollowSymLinks

# Configuración de sesiones PHP
php_value session.cookie_httponly 1
php_value session.use_only_cookies 1
php_value session.cookie_secure 0
php_value session.gc_maxlifetime 7200

# Configuración de memoria y tiempo
php_value memory_limit 256M
php_value max_execution_time 60
php_value max_input_time 60
php_value post_max_size 10M
php_value upload_max_filesize 5M